/// <reference types="@workadventure/iframe-api-typings" />

/**
 * malware_discord.ts
 *
 * Area:   "malware_discord"
 * Anchor: "malware_discordPopup"  (create this rectangle anchor in Tiled)
 *
 * Behavior:
 *  - OnEnter -> open a single popup (closes any previous instance)
 *  - Two choices: "Decline the program" and "Download & install"
 *  - Each choice opens a follow-up popup with the appropriate guidance
 *  - OnLeave -> close any open popup and clear refs so popups do not stack
 */

let previewRef: any | undefined;

const AREA = "malware_discord";
const ANCHOR = "malware_discordPopup";

export function initMalwareDiscord() {
  WA.onInit().then(() => {
    // When player enters the anchor area, show the first popup
    WA.room.area.onEnter(AREA).subscribe(() => {
      closePopup();
      previewRef = WA.ui.openPopup(
        ANCHOR,
        `💬 Friend sent a file\n\nYour friend messages you on Discord about a program that "unlocks Discord Nitro Premium for life".\n\nWhat do you do?`,
        [
          {
            label: "Decline the program",
            className: "primary",
            callback: () => {
              closePopup();
              showDeclineResponse();
            },
          },
          {
            label: "Download & install",
            callback: () => {
              closePopup();
              showInstallResponse();
            },
          },
        ]
      );
    });

    // Always close when leaving the area so popups don't remain or stack
    WA.room.area.onLeave(AREA).subscribe(() => {
      closePopup();
    });
  });
}

/* ---------------- follow-up popups ---------------- */

function showDeclineResponse() {
  // Good outcome explanation
  try { previewRef?.close?.(); } catch {}
  previewRef = WA.ui.openPopup(
    ANCHOR,
    `✅ Decline — Good call!\n\nMany tools that promise to "crack" paid subscriptions will either bundle malware or change system settings to gain persistent access. Even if the tool works, it could expose you to data theft, camera/mic access, or remote control.\n\nTip: Encourage your friend to stop sharing suspicious installers and scan their machine with antivirus if they used it.`,
    [
      {
        label: "Got it",
        className: "primary",
        callback: () => closePopup(),
      },
    ]
  );
}

function showInstallResponse() {
  // Risky outcome explanation — encourage the player to reconsider
  try { previewRef?.close?.(); } catch {}
  previewRef = WA.ui.openPopup(
    ANCHOR,
    `⚠️ Download & install — Risky move\n\nSome “crack” tools do work to unlock features but they commonly hide malicious code. Installing them may:
• Give attackers access to your files and camera/microphone,
• Install backdoors or keyloggers,
• Spread the malicious program to your contacts.\n\nRecommended: Delete the file, run a scan, and do not install unknown programs — even if they were shared by friends.`,
    [
      {
        label: "I’ll delete the file",
        className: "primary",
        callback: () => {
          closePopup();
          WA.ui.displayActionMessage({
            message: "Good — deleting unknown installers and scanning is safer.",
            callback: () => {},
          });
        },
      },
      {
        label: "Undo (go back)",
        callback: () => {
          closePopup();
          // Re-open initial choice so the player can pick again
          WA.ui.openPopup(
            ANCHOR,
            `💬 Friend sent a file\n\nYour friend messages you on Discord about a program that "unlocks Discord Nitro Premium for life".\n\nWhat do you do?`,
            [
              {
                label: "Decline the program",
                className: "primary",
                callback: () => {
                  closePopup();
                  showDeclineResponse();
                },
              },
              {
                label: "Download & install",
                callback: () => {
                  closePopup();
                  showInstallResponse();
                },
              },
            ]
          );
        },
      },
    ]
  );
}

/* ---------------- utility ---------------- */

function closePopup() {
  try {
    if (previewRef) {
      previewRef.close?.();
      previewRef = undefined; // important: clear ref so future opens aren't stacked
    }
  } catch {
    previewRef = undefined;
  }
}
