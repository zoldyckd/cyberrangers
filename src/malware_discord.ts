/// <reference types="@workadventure/iframe-api-typings" />

let popupRef: any | undefined;

const AREA   = "malware_discord";
const ANCHOR = "malware_discordPopup";

export function initMalwareDiscord() {
  WA.onInit().then(() => {
    console.log("[WA] Malware Discord popup ready");

    WA.room.area.onEnter(AREA).subscribe(() => {
      openPopup();
    });

    WA.room.area.onLeave(AREA).subscribe(() => {
      closePopup();
    });
  });
}

function openPopup() {
  // prevent duplicates
  closePopup();

  popupRef = WA.ui.openPopup(
    ANCHOR,
    "ðŸ’¬ Your friend DMs you on Discord about a program that â€œunlocks Discord Nitro Premium for lifeâ€ and says itâ€™s safe because they used it.\n\nWhat would you do? Press SPACE to help!",
    [
      {
        label: "Got it!",
        className: "primary",
        callback: () => closePopup(),
      },
    ]
  );
}

function closePopup() {
  try { popupRef?.close?.(); } catch {}
  popupRef = undefined;
}
